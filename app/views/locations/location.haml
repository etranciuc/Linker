.bar-nav
  %h1.title Linker

#map_overlay
  #map_window

#map_canvas


.message
  Please wait while we gather your location!


= content_for :scripts do
  :coffee
    jQuery ->
      show_error = (error) ->
        # Geolocation not authorized
        if error.code == 1
          $('.message').text("Sorry, we need geolocation info")
        else
          console.log error


      acquire_position = (geo_position) ->

        # Create a custom position object to display map
        position = {
          latitude: geo_position.coords.latitude
          longitude: geo_position.coords.longitude
        }
        send_data(position)
        #display_map(position)

      send_data = (position) ->
        options = {
          url: "/location_data"
          type: "get"
          data: position = { position }
          complete: received_response
        }
        $.ajax(options)


      display_map = (position) ->
        pos = new google.maps.LatLng(position.latitude, position.longitude)
        mapOptions = {
          zoom: 15,
          zoomControl: false,
          scrollwheel: false, 
          disableDoubleClickZoom: true,
          draggable: false,
          disableDefaultUI: true,
          mapTypeId: google.maps.MapTypeId.ROADMAP
          center: pos
        }
        map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);
        marker = new google.maps.Marker({
          position: pos, 
          position: map.getCenter(),
          map: map
        })

        # After having loaded the map, wait a short time a redirect
        # setTimeout(
        #  () -> 
        #     window.location.href = "http://www.google.com"
        # , 5000)




      received_response = (response, status) -> 
        position = response.responseJSON
        display_map(position)

      if navigator.geolocation 
        navigator.geolocation.getCurrentPosition(acquire_position, show_error)
      else


        $('.message').text("Sorry, we need geolocation info")

